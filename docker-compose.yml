services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: devflow-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: devflow
      POSTGRES_USER: devflow
      POSTGRES_PASSWORD: changeme
    ports:
      - '5432:5432'
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U devflow']
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: devflow-redis
    restart: unless-stopped
    ports:
      - '6379:6379'
    volumes:
      - redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  # Qdrant Vector Database
  qdrant:
    image: qdrant/qdrant:v1.11.3
    container_name: devflow-qdrant
    restart: unless-stopped
    ports:
      - '6333:6333'
      - '6334:6334'
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    # Note: Qdrant image doesn't have curl/wget, using simple port check
    healthcheck:
      test: ['CMD-SHELL', 'timeout 1 bash -c "</dev/tcp/localhost/6333" || exit 1']
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # Temporal Server
  temporal:
    image: temporalio/auto-setup:1.22.4
    container_name: devflow-temporal
    restart: unless-stopped
    ports:
      - '7233:7233'
      - '8233:8233'
    environment:
      - DB=postgresql
      - DB_PORT=5432
      - POSTGRES_USER=devflow
      - POSTGRES_PWD=changeme
      - POSTGRES_SEEDS=postgres
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - temporal-data:/etc/temporal

  # Temporal Web UI
  temporal-ui:
    image: temporalio/ui:2.21.3
    container_name: devflow-temporal-ui
    restart: unless-stopped
    ports:
      - '8080:8080'
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000
    depends_on:
      - temporal

  # DevFlow API (NestJS)
  api:
    build:
      context: .
      dockerfile: ./packages/api/Dockerfile
    container_name: devflow-api
    restart: unless-stopped
    ports:
      - '3001:8000'
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - PORT=8000
      - DATABASE_URL=postgresql://devflow:changeme@postgres:5432/devflow?schema=public
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=devflow
      - DATABASE_USER=devflow
      - DATABASE_PASSWORD=changeme
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - TEMPORAL_ADDRESS=temporal:7233
      # Email (Mailpit)
      - SMTP_HOST=mailpit
      - SMTP_PORT=1025
      - SMTP_FROM=noreply@devflow.local
      - SMTP_SECURE=false
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      temporal:
        condition: service_started
      mailpit:
        condition: service_healthy
    # volumes:
    #   - ./packages/api:/app/packages/api
    #   - ./packages/common:/app/packages/common
    #   - ./packages/sdk:/app/packages/sdk
    #   - /app/node_modules
    #   - /app/packages/api/node_modules

  # DevFlow Worker (Temporal)
  worker:
    build:
      context: .
      dockerfile: ./packages/worker/Dockerfile
    container_name: devflow-worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Docker-specific overrides (hostnames inside Docker network)
      - NODE_ENV=development
      - DATABASE_URL=postgresql://devflow:changeme@postgres:5432/devflow?schema=public
      - DATABASE_HOST=postgres
      - DATABASE_PORT=5432
      - DATABASE_NAME=devflow
      - DATABASE_USER=devflow
      - DATABASE_PASSWORD=changeme
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_URL=redis://redis:6379
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - TEMPORAL_ADDRESS=temporal:7233
      # LLM Council - Multi-model deliberation
      - ENABLE_COUNCIL=true
      - COUNCIL_MODELS=anthropic/claude-sonnet-4,openai/gpt-4o,google/gemini-2.0-flash-exp
      - COUNCIL_CHAIRMAN_MODEL=anthropic/claude-sonnet-4
      - COUNCIL_TIMEOUT=120000
      # Ollama - Local LLM for code generation (Phase 4)
      - OLLAMA_BASE_URL=http://ollama:11434
      - OLLAMA_CODE_MODEL=deepseek-coder:6.7b
      - OLLAMA_EMBEDDINGS_MODEL=nomic-embed-text
      - ENABLE_OLLAMA=true
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      temporal:
        condition: service_started
      ollama:
        condition: service_healthy
    # volumes:
    #   - ./packages/worker:/app/packages/worker
    #   - ./packages/common:/app/packages/common
    #   - ./packages/sdk:/app/packages/sdk
    #   - /app/node_modules
    #   - /app/packages/worker/node_modules

  # DevFlow Web (Nuxt.js Frontend)
  web:
    build:
      context: ./packages/web
      dockerfile: Dockerfile.dev
    container_name: devflow-web
    restart: unless-stopped
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=development
      - NUXT_PUBLIC_API_BASE=http://localhost:3001/api/v1
    volumes:
      - ./packages/web:/app
      - /app/node_modules
      - /app/.nuxt
    depends_on:
      - api

  # Mailpit - Email testing (development only)
  mailpit:
    image: axllent/mailpit:latest
    container_name: devflow-mailpit
    restart: unless-stopped
    ports:
      - '8025:8025'   # Web UI
      - '1025:1025'   # SMTP
    environment:
      - MP_SMTP_AUTH_ACCEPT_ANY=true
      - MP_SMTP_AUTH_ALLOW_INSECURE=true
    healthcheck:
      test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:8025/api/v1/info']
      interval: 10s
      timeout: 5s
      retries: 5

  # Ollama - Local LLM inference (privacy-first, no cloud fallback)
  ollama:
    image: ollama/ollama:latest
    container_name: devflow-ollama
    restart: unless-stopped
    ports:
      - '11434:11434'
    volumes:
      - ollama-models:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
      - OLLAMA_ORIGINS=*
    # GPU passthrough (uncomment for NVIDIA GPU support)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://localhost:11434/api/tags || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Ollama model initialization (pulls models on first run)
  ollama-init:
    image: curlimages/curl:latest
    container_name: devflow-ollama-init
    depends_on:
      ollama:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "Pulling Ollama models for code generation..."
        curl -X POST http://ollama:11434/api/pull -d '{"name":"deepseek-coder:6.7b"}' && \
        echo "deepseek-coder:6.7b pulled successfully" && \
        curl -X POST http://ollama:11434/api/pull -d '{"name":"nomic-embed-text"}' && \
        echo "nomic-embed-text pulled successfully" && \
        echo "All models ready!"
    restart: "no"

  # Ngrok tunnel for webhooks (development only)
  ngrok:
    image: ngrok/ngrok:latest
    container_name: devflow-ngrok
    restart: unless-stopped
    command:
      - "start"
      - "--all"
      - "--config"
      - "/etc/ngrok.yml"
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml
    ports:
      - 4040:4040
    depends_on:
      - api

  # Prometheus - Metrics collection and storage
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: devflow-prometheus
    restart: unless-stopped
    ports:
      - '9090:9090'
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    depends_on:
      - api
      - worker

  # Grafana - Visualization and dashboards
  grafana:
    image: grafana/grafana:10.2.2
    container_name: devflow-grafana
    restart: unless-stopped
    ports:
      - '3002:3000'
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3002
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning
      - ./config/grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus

volumes:
  postgres-data:
  redis-data:
  qdrant-data:
  temporal-data:
  prometheus-data:
  grafana-data:
  ollama-models:

